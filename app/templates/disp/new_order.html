{% extends "base.html" %}
{% block header_title %}Новый заказ{% endblock %}

{% block content %}
<div class="main__order-wrapper">
    <form id="order-form" method="post" action="/api/orders/">
        <div class="main__order-wrapper-blocks">
            <div class="main__order-settings">
                <div class="main__order-header">
                    <div class="main__order-header-item">
                        <p>Заказ №</p>
                        <input type="text" id="order-number" name="order_number" readonly class="main__btn-short" value="{{ order_number }}">
                    </div>
                    <div class="main__order-header-item">
                        <p>Дата время</p>
                        <input type="text" id="order-date" name="order_date" readonly class="main__btn-short" value="{{ now.strftime('%d.%m.%y') }}">
                        <input type="text" id="order-time" name="order_time" readonly class="main__btn-short" value="{{ now.strftime('%H:%M') }}">
                    </div>
                    <div class="main__order-header-item">
                        <p>Путевой лист</p>
                        <input type="text" id="route-number" name="route_number" readonly class="main__btn-short" value="{{ route_number }}">
                    </div>
                </div>
                <div class="main__order-subheader">
                    <div class="main__order-subheader-item">
                        <select id="driver-select" name="driver_id" class="main__btn-short">
                            <option value disabled selected>Выберите водителя</option>
                            {% for driver in drivers %}
                            <option value="{{ driver.id }}" data-phone="{{ driver.phone|default('+996 (XXX) XX-XX-XX') }}" data-tariff="{{ driver.tariff }}">
                                {{ driver.full_name }}
                            </option>
                            {% endfor %}
                        </select>
                        <input type="text" id="driver-phone" readonly class="main__btn-short" value="+996 (XXX) XX-XX-XX">
                    </div>
                    <div class="main__order-subheader-item">
                        <div class="main__subheader-filing">
                            <select id="tariff-select" name="tariff">
                                <option value disabled selected>Вариант</option>
                                <option value="Эконом">Эконом</option>
                                <option value="Комфорт">Комфорт</option>
                                <option value="Комфорт+">Комфорт+</option>
                                <option value="Бизнес">Бизнес</option>
                            </select>
                        </div>
                        <div class="main__subheader-filing">
                            <select id="payment-method" name="payment_method">
                                <option value disabled selected>Оплата</option>
                                <option value="Наличные">Наличные</option>
                                <option value="На карту">На карту</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="main__order-details">
                    <div class="main__order-details-item main__order-details-where">
                        <input type="text" id="origin-address" name="origin" placeholder="Откуда (адрес отправления)" class="main__btn" style="width: 100%;"/>
                    </div>
                    <div class="main__order-details-item main__order-details-whither">
                        <input type="text" id="destination-address" name="destination" placeholder="Куда (адрес назначения)" class="main__btn" style="width: 100%;"/>
                    </div>
                </div>
                <div class="main__order-notes">
                    <div class="main__order-notes-text">
                        <textarea id="notes" name="notes" placeholder="Примечание"></textarea>
                    </div>
                    <div class="main__order-notes-settings">
                        <button type="button" class="main__btn-short">Заказ другому человеку</button>
                        <button type="button" class="main__btn-short">Дополнительные услуги</button>
                    </div>
                </div>
                <div class="main__table">
                    <table>
                        <thead>
                            <tr>
                                <th>Заказ</th>
                                <th>Время</th>
                                <th>Откуда</th>
                                <th>Куда</th>
                                <th>Сумма</th>
                            </tr>
                        </thead>
                        <tbody id="recent-orders">
                            {% if orders %}
                            {% for order in orders %}
                            <tr>
                                <td>{{ order.id }}</td>
                                <td>{{ order.time }} {{ order.created_at.strftime('%d.%m.%y') }}</td>
                                <td>{{ order.origin }}</td>
                                <td>{{ order.destination }}</td>
                                <td>{{ order.price|default('') }}</td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="5">Нет данных о последних заказах</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="main__order-map">
                <div class="main__order-map-item" id="map-container">
                    <!-- 2ГИС карта будет загружена сюда -->
                </div>
                <div class="main__order-map-settings">
                    <div class="main__order-map-settings">
                        <button type="button" class="main__btn">Данные для рассчета</button>
                        <button type="button" id="clear-markers-btn" class="main__btn-short" style="background-color: #dc3545; margin-left: 10px;">Очистить маркеры</button>
                    </div>
                    <div class="route-info">
                        <div class="route-info-item">
                            <input type="text" id="tariff-display" readonly class="main__btn-short" value="Эконом">
                        </div>
                        <div class="route-info-item">
                            <input type="text" id="boarding-fee" readonly class="main__btn-short" value="Посадка: 48 сом">
                        </div>
                        <div class="route-info-item">
                            <input type="text" id="distance" readonly class="main__btn-short" value="Расстояние: 0 км">
                        </div>
                        <div class="route-info-item">
                            <input type="text" id="price" readonly class="main__btn-short" value="Стоимость: 0 сом">
                            <input type="hidden" id="calculated-price" name="price" value="0">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="main__order-wrapper-btn">
            <button type="submit" class="main__btn-green">Заказать</button>
            <button type="button" id="cancel-btn" class="main__btn">Отменить</button>
        </div>
    </form>
</div>

<!-- Подключение 2ГИС MapGL JS API -->
<script src="https://mapgl.2gis.com/api/js/v1"></script>
<script>
    // Ждём загрузки DOM и jQuery
    document.addEventListener('DOMContentLoaded', function() {
        // Ждём также загрузки jQuery
        function waitForJQuery() {
            if (typeof $ !== 'undefined') {
                initApp();
            } else {
                setTimeout(waitForJQuery, 100);
            }
        }
        waitForJQuery();
    });

    function initApp() {
        console.log('jQuery готов');
        
        // Константы для тарифов
        const TARIFFS = {
            'Эконом': {
                boardingFee: 48,
                waitingFreeMinutes: 3,
                waitingPricePerMinute: 5,
                cityPricePerKm: 8.5,
                cityPricePerMinute: 3.9,
                outsideCityPricePerKm: 23,
                outsideCityPricePerMinute: 3.9
            },
            'Комфорт': {
                boardingFee: 60,
                waitingFreeMinutes: 3,
                waitingPricePerMinute: 6,
                cityPricePerKm: 10.5,
                cityPricePerMinute: 4.9,
                outsideCityPricePerKm: 25,
                outsideCityPricePerMinute: 4.9
            },
            'Комфорт+': {
                boardingFee: 75,
                waitingFreeMinutes: 3,
                waitingPricePerMinute: 6.5,
                cityPricePerKm: 13,
                cityPricePerMinute: 6.2,
                outsideCityPricePerKm: 28,
                outsideCityPricePerMinute: 6.2
            },
            'Бизнес': {
                minimumPrice: 80,
                boardingFee: 80,
                waitingFreeMinutes: 3,
                waitingPricePerMinute: 7,
                cityPricePerKm: 14,
                cityPricePerMinute: 6.5,
                outsideCityPricePerKm: 30,
                outsideCityPricePerMinute: 6.5
            }
        };
        
        // Функция обновления времени (Киргизское время, GMT+6)
        function updateKyrgyzTime() {
            try {
                const now = new Date();
                // Получаем UTC время и добавляем 6 часов для Киргизии (GMT+6)
                const kyrgyzTime = new Date(now.getTime() + (6 * 60 * 60 * 1000));
                
                const orderTimeElement = document.getElementById('order-time');
                if (orderTimeElement) {
                    orderTimeElement.value = kyrgyzTime.toLocaleTimeString('ru-RU', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false,
                        timeZone: 'Asia/Bishkek'
                    });
                }
            } catch (error) {
                console.error('Ошибка при обновлении времени:', error);
            }
        }
        
        updateKyrgyzTime();
        setInterval(updateKyrgyzTime, 1000);

        // База данных полных адресов Киргизии (с номерами домов)
        const kyrgyzstanAddresses = [
            // Город Ош - популярные адреса
            'ул. Ленина, 1', 'ул. Ленина, 5', 'ул. Ленина, 12', 'ул. Ленина, 18', 'ул. Ленина, 25',
            'ул. Курманжан Датка, 2', 'ул. Курманжан Датка, 8', 'ул. Курманжан Датка, 15', 'ул. Курманжан Датка, 22',
            'ул. Навои, 3', 'ул. Навои, 7', 'ул. Навои, 14', 'ул. Навои, 20', 'ул. Навои, 28',
            'ул. Кувандык, 4', 'ул. Кувандык, 9', 'ул. Кувандык, 16', 'ул. Кувандык, 24',
            'ул. Исанова, 6', 'ул. Исанова, 11', 'ул. Исанова, 17', 'ул. Исанова, 23',
            'ул. Мырзалы Аматова, 2', 'ул. Мырзалы Аматова, 10', 'ул. Мырзалы Аматова, 19',
            'ул. Токтогула, 5', 'ул. Токтогула, 13', 'ул. Токтогула, 21', 'ул. Токтогула, 30',
            'ул. Абдрахманова, 1', 'ул. Абдрахманова, 8', 'ул. Абдрахманова, 15',
            'ул. Мадания, 3', 'ул. Мадания, 12', 'ул. Мадания, 26',
            'ул. Карасу, 2', 'ул. Карасу, 7', 'ул. Карасу, 14', 'ул. Карасу, 21',
            'ул. Салиева, 4', 'ул. Салиева, 11', 'ул. Салиева, 18',
            'ул. Омурзакова, 6', 'ул. Омурзакова, 13', 'ул. Омурзакова, 20',
            'ул. Айтматова, 1', 'ул. Айтматова, 9', 'ул. Айтматова, 16',
            'пр. Жайлау, 5', 'пр. Жайлау, 12', 'пр. Жайлау, 19',
            'пр. Масалиева, 3', 'пр. Масалиева, 10', 'пр. Масалиева, 17',
            'мкр. Аэропорт, 1', 'мкр. Аэропорт, 2', 'мкр. Аэропорт, 3',
            'мкр. Центр, 1', 'мкр. Центр, 2', 'мкр. Центр, 4',
            
            // Бишкек - основные адреса
            'ул. Киевская, 1', 'ул. Киевская, 15', 'ул. Киевская, 25', 'ул. Киевская, 42',
            'ул. Токтогула, 3', 'ул. Токтогула, 18', 'ул. Токтогула, 33', 'ул. Токтогула, 48',
            'ул. Манас, 5', 'ул. Манас, 12', 'ул. Манас, 28', 'ул. Манас, 35',
            'ул. Чуй, 2', 'ул. Чуй, 19', 'ул. Чуй, 36', 'ул. Чуй, 51',
            'ул. Исанова, 4', 'ул. Исанова, 21', 'ул. Исанова, 38',
            'ул. Боконбаева, 7', 'ул. Боконбаева, 16', 'ул. Боконбаева, 29',
            'ул. Московская, 1', 'ул. Московская, 13', 'ул. Московская, 24',
            'ул. Турусбекова, 6', 'ул. Турусбекова, 17', 'ул. Турусбекова, 32',
            'ул. Жибек Жолу, 2', 'ул. Жибек Жолу, 14', 'ул. Жибек Жолу, 27',
            'пр. Мира, 5', 'пр. Мира, 18', 'пр. Мира, 31', 'пр. Мира, 44',
            'пр. Чуй, 3', 'пр. Чуй, 22', 'пр. Чуй, 41', 'пр. Чуй, 56',
            'пр. Ден Сяопина, 1', 'пр. Ден Сяопина, 8', 'пр. Ден Сяопина, 15',
            'мкр. Джал, 1', 'мкр. Джал, 3', 'мкр. Джал, 6',
            'мкр. Асанбай, 2', 'мкр. Асанбай, 4', 'мкр. Асанбай, 7',
            
            // Джалал-Абад
            'ул. Эркиндик, 1', 'ул. Эркиндик, 12', 'ул. Эркиндик, 23',
            'ул. Токтогула, 5', 'ул. Токтогула, 16', 'ул. Токтогула, 27',
            'ул. Ленина, 3', 'ул. Ленина, 14', 'ул. Ленина, 25',
            'ул. Советская, 2', 'ул. Советская, 9', 'ул. Советская, 18',
            
            // Каракол
            'ул. Токтогула, 1', 'ул. Токтогула, 8', 'ул. Токтогула, 15',
            'ул. Абдрахманова, 4', 'ул. Абдрахманова, 11', 'ул. Абдрахманова, 19',
            'ул. Гагарина, 2', 'ул. Гагарина, 7', 'ул. Гагарина, 14',
            'ул. Московская, 6', 'ул. Московская, 13', 'ул. Московская, 20',
            
            // Нарын
            'ул. Ленина, 1', 'ул. Ленина, 9', 'ул. Ленина, 16',
            'ул. Бердике Баатыра, 3', 'ул. Бердике Баатыра, 12', 'ул. Бердике Баатыра, 21',
            'ул. Салиева, 5', 'ул. Салиева, 14', 'ул. Салиева, 23',
            
            // Талас
            'ул. Бердике Баатыра, 2', 'ул. Бердике Баатыра, 10', 'ул. Бердике Баатыра, 18',
            'ул. Фрунзе, 4', 'ул. Фрунзе, 13', 'ул. Фрунзе, 22',
            'ул. Ленина, 1', 'ул. Ленина, 8', 'ул. Ленина, 17',
            
            // Баткен
            'ул. Ленина, 1', 'ул. Ленина, 6', 'ул. Ленина, 12',
            'ул. Салиева, 3', 'ул. Салиева, 9', 'ул. Салиева, 15',
            
            // Популярные места и ориентиры
            'Ошский рынок', 'Центральная мечеть, Ош', 'Аэропорт Ош',
            'ТЦ Ош-Плаза', 'Парк Навои, Ош', 'Железнодорожный вокзал, Ош',
            'Медицинский центр, Ош', 'Университет, Ош', 'Стадион, Ош',
            'Ала-Тоо площадь, Бишкек', 'ТЦ Вефа, Бишкек', 'Ошский рынок, Бишкек',
            'Аэропорт Манас, Бишкек', 'Парк Ататюрк, Бишкек', 'ЖД вокзал, Бишкек'
        ];

        // Переменные для карты 2ГИС MapGL
        let map;
        let originMarker;
        let destinationMarker;
        let routeLayer;
        let distance = 0;
        let duration = 0;
        let originCoords = null;
        let destinationCoords = null;
        let clickCounter = 0; // Счетчик кликов: 0/2 = точка А, 1 = точка Б

        // Инициализация карты 2ГИС MapGL
        function initMap() {
            try {
                console.log('Инициализация карты 2ГИС MapGL...');
                
                // Проверяем, что MapGL доступен
                if (typeof mapgl === 'undefined') {
                    console.error('MapGL API не загружен');
                    return;
                }
                
                // Центр города Ош, Киргизия
                const oshCenter = [72.8019, 40.5138]; // [lng, lat] для MapGL - город Ош
                
                map = new mapgl.Map('map-container', {
                    center: oshCenter,
                    zoom: 12, // Увеличиваем зум для города
                    key: '3025505a-cdb6-4ddc-819b-1c546552efe3',
                    minZoom: 5,
                    maxZoom: 18
                });
                
                console.log('Карта 2ГИС MapGL создана для города Ош');

                // Добавляем обработчик ЛЕВОЙ кнопки мыши для установки точек
                map.on('click', function(e) {
                    const coords = e.lngLat;
                    
                    // Проверяем, что координаты находятся в пределах Киргизии
                    if (isWithinKyrgyzstan(coords.lat, coords.lng)) {
                        console.log('✅ Клик левой кнопкой по координатам в Киргизии:', coords.lat, coords.lng);
                        
                        // Поочередно устанавливаем точки А и Б
                        if (clickCounter % 2 === 0) {
                            // Устанавливаем точку А (откуда)
                            setMarkerByClick(coords, 'origin');
                            console.log('🅰️ Установлена точка А (откуда)');
                        } else {
                            // Устанавливаем точку Б (куда)
                            setMarkerByClick(coords, 'destination');
                            console.log('🅱️ Установлена точка Б (куда)');
                        }
                        
                        clickCounter++;
                    } else {
                        console.warn('⚠️ Точка находится вне территории Киргизии:', coords.lat, coords.lng);
                        // Не блокируем - все равно устанавливаем маркер
                        if (clickCounter % 2 === 0) {
                            setMarkerByClick(coords, 'origin');
                            console.log('🅰️ Установлена точка А (вне Киргизии)');
                        } else {
                            setMarkerByClick(coords, 'destination');
                            console.log('🅱️ Установлена точка Б (вне Киргизии)');
                        }
                        clickCounter++;
                    }
                });
                
                console.log('Карта 2ГИС MapGL успешно инициализирована для города Ош');
                console.log('💡 Инструкция:');
                console.log('   • Кликайте левой кнопкой: 1-й клик = точка А, 2-й клик = точка Б');
                console.log('   • Или вводите адреса в поля - маркеры ставятся автоматически');
                console.log('   • Выбирайте из списка автодополнения для быстрого ввода');
            } catch (error) {
                console.error('Ошибка при инициализации карты 2ГИС MapGL:', error);
            }
        }

        // Проверка, находится ли точка в пределах Киргизии (расширенные границы)
        function isWithinKyrgyzstan(lat, lng) {
            // Расширяем границы для более точного покрытия Киргизии
            return (lat >= 39.0 && lat <= 43.5 && lng >= 69.0 && lng <= 80.5);
        }

        // Функция для геокодирования адреса (получение координат по адресу)
        function geocodeAddress(address, callback) {
            // Упрощенная функция геокодирования на основе наших данных
            const addressCoords = {
                // Основные координаты городов и улиц
                'ош': [72.8019, 40.5138],
                'бишкек': [74.5975, 42.8746],
                'джалал-абад': [72.9358, 40.9333],
                'каракол': [78.3933, 42.4906],
                'нарын': [76.0000, 41.4286],
                'талас': [72.2424, 42.5228],
                'баткен': [70.8167, 40.0642],
                
                // Конкретные улицы в Оше (координаты примерные)
                'ул. ленина': [72.8019, 40.5138],
                'ул. курманжан датка': [72.8050, 40.5150],
                'ул. навои': [72.8100, 40.5120],
                'ул. карасу': [72.7950, 40.5160],
                'ул. токтогула': [72.8080, 40.5140],
                'ул. исанова': [72.8030, 40.5130],
                
                // Улицы в Бишкеке
                'ул. чуй': [74.5975, 42.8746],
                'ул. киевская': [74.6000, 42.8760],
                'ул. московская': [74.6020, 42.8740],
                'пр. мира': [74.5950, 42.8750],
                
                // Популярные места
                'ошский рынок': [72.8000, 40.5145],
                'аэропорт ош': [72.7929, 40.6090],
                'аэропорт манас': [74.4776, 43.0612],
                'ала-тоо площадь': [74.5900, 42.8760]
            };
            
            const normalizedAddress = address.toLowerCase();
            
            // Ищем точное совпадение
            for (const [key, coords] of Object.entries(addressCoords)) {
                if (normalizedAddress.includes(key)) {
                    callback(coords[0], coords[1]); // lng, lat
                    return;
                }
            }
            
            // Если не нашли точного совпадения, используем координаты Оша по умолчанию
            callback(72.8019, 40.5138);
        }

        // Функция для установки маркера при клике (улучшенная)
        function setMarkerByClick(coords, type) {
            console.log('Установка маркера', type, 'по координатам:', coords.lat, coords.lng);
            
            // Простое использование координат
            const address = `${coords.lat.toFixed(6)}, ${coords.lng.toFixed(6)}`;
                    
            // Устанавливаем маркер
            if (type === 'origin') {
                if (originMarker) {
                    originMarker.destroy();
                }
                
                originCoords = [coords.lng, coords.lat]; // Сохраняем координаты
                originMarker = new mapgl.Marker(map, {
                    coordinates: originCoords,
                    icon: 'https://docs.2gis.com/img/nav-gp-pin.svg'
                });
                
                // Заполняем поле адреса
                $('#origin-address').val(address);
                console.log('✅ Точка А установлена:', address);
                        
            } else if (type === 'destination') {
                if (destinationMarker) {
                    destinationMarker.destroy();
                }
                
                destinationCoords = [coords.lng, coords.lat]; // Сохраняем координаты
                destinationMarker = new mapgl.Marker(map, {
                    coordinates: destinationCoords,
                    icon: 'https://docs.2gis.com/img/nav-gp-pin.svg'
                });
                
                // Заполняем поле адреса
                $('#destination-address').val(address);
                console.log('✅ Точка Б установлена:', address);
            }
                    
            // Обновляем маршрут, если оба адреса установлены
            if ($('#origin-address').val() && $('#destination-address').val()) {
                console.log('🗺️ Оба адреса установлены, рассчитываем маршрут...');
                calculateRoute();
            }
        }

        // Функция для установки маркера по адресу (новая)
        function setMarkerByAddress(address, type) {
            if (!address || address.length < 2) return;
            
            console.log('Геокодирование адреса:', address, 'для типа:', type);
            
            geocodeAddress(address, function(lng, lat) {
                const coords = { lng: lng, lat: lat };
                
                console.log('Получены координаты для адреса', address, ':', lng, lat);
                    
                    // Устанавливаем маркер
                    if (type === 'origin') {
                        if (originMarker) {
                        originMarker.destroy();
                    }
                    
                    originCoords = [lng, lat];
                    originMarker = new mapgl.Marker(map, {
                        coordinates: originCoords,
                        icon: 'https://docs.2gis.com/img/nav-gp-pin.svg'
                    });
                    
                    console.log('✅ Маркер точки А установлен по адресу');
                        
                    } else if (type === 'destination') {
                        if (destinationMarker) {
                        destinationMarker.destroy();
                    }
                    
                    destinationCoords = [lng, lat];
                    destinationMarker = new mapgl.Marker(map, {
                        coordinates: destinationCoords,
                        icon: 'https://docs.2gis.com/img/nav-gp-pin.svg'
                    });
                    
                    console.log('✅ Маркер точки Б установлен по адресу');
                }
                
                // Центрируем карту на новом маркере
                map.setCenter([lng, lat]);
                    
                    // Обновляем маршрут, если оба адреса установлены
                if (originCoords && destinationCoords) {
                    console.log('🗺️ Оба маркера установлены, рассчитываем маршрут...');
                        calculateRoute();
                }
            });
        }

        // Расчет маршрута
        function calculateRoute() {
            try {
                console.log('Расчет маршрута через 2ГИС MapGL');
                const origin = $('#origin-address').val();
                const destination = $('#destination-address').val();
            
            if (!origin || !destination) {
                console.log('Не заданы начальная или конечная точки маршрута');
                return;
            }
            
                // Простой расчет расстояния (примерный)
                if (originCoords && destinationCoords) {
                    // Расчет расстояния по прямой (в километрах)
                    distance = calculateDistance(originCoords[1], originCoords[0], destinationCoords[1], destinationCoords[0]);
                    // Примерное время в минутах (средняя скорость 30 км/ч в городе)
                    duration = (distance / 30) * 60;
                    
                    console.log('Расстояние:', distance.toFixed(1), 'км, время:', duration.toFixed(0), 'мин');
                    
                    $('#distance').val(`Расстояние: ${distance.toFixed(1)} км`);
                    
                    // Пересчитываем стоимость
                    calculatePrice();
                    
                    // Показываем линию маршрута
                    if (routeLayer) {
                        routeLayer.destroy();
                    }
                    
                    routeLayer = new mapgl.Polyline(map, {
                        coordinates: [originCoords, destinationCoords],
                        color: '#00FFFC',
                        width: 5
                    });
                    
                    // Подстраиваем карту под маршрут
                    const bounds = [
                        [Math.min(originCoords[0], destinationCoords[0]), Math.min(originCoords[1], destinationCoords[1])],
                        [Math.max(originCoords[0], destinationCoords[0]), Math.max(originCoords[1], destinationCoords[1])]
                    ];
                    map.fitBounds(bounds, { padding: 50 });
                }
            } catch (error) {
                console.error('Ошибка расчета маршрута:', error);
            }
        }

        // Функция расчета расстояния между двумя точками
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Радиус Земли в км
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Расчет стоимости поездки
        function calculatePrice() {
            try {
                const tariff = $('#tariff-select').val();
                console.log('Расчет цены для тарифа:', tariff);
                
                if (!tariff || !TARIFFS[tariff]) {
                    console.error('Тариф не выбран или не найден в списке тарифов:', tariff);
                    return;
                }

                const tariffData = TARIFFS[tariff];
                let price = tariffData.boardingFee;
                
                // Обновляем отображение тарифа
                $('#tariff-display').val(tariff);
                
                // Расчет стоимости в зависимости от расстояния
                if (distance > 0) {
                    const pricePerKm = tariffData.cityPricePerKm;
                    const pricePerMinute = tariffData.cityPricePerMinute;
                    
                    const distancePrice = distance * pricePerKm;
                    const timePrice = duration * pricePerMinute;
                    
                    price += distancePrice + timePrice;
                }
                
                // Минимальная стоимость для бизнес-класса
                if (tariff === 'Бизнес' && price < tariffData.minimumPrice) {
                    price = tariffData.minimumPrice;
                }
                
                // Округляем до целого числа
                price = Math.ceil(price);
                
                $('#price').val(`Стоимость: ${price} сом`);
                $('#calculated-price').val(price);
                $('#boarding-fee').val(`Посадка: ${tariffData.boardingFee} сом`);
                
                console.log('Расчет стоимости:', {
                    тариф: tariff,
                    расстояние: distance.toFixed(1) + ' км',
                    время: duration.toFixed(0) + ' мин',
                    цена: price + ' сом'
                });
            } catch (error) {
                console.error('Ошибка при расчете стоимости:', error);
            }
        }

        // Инициализация карты при загрузке страницы
        $(window).on('load', function() {
            console.log('Страница полностью загружена, инициализация карты...');
            setTimeout(function() {
                try {
                    initMap();
                    console.log('Карта инициализирована после загрузки страницы');
                } catch (error) {
                    console.error('Ошибка инициализации карты после загрузки страницы:', error);
                }
            }, 500);
        });

        // Обработчики событий
        $('#driver-select').change(function() {
            const selectedOption = $(this).find('option:selected');
            const phone = selectedOption.data('phone');
            const tariff = selectedOption.data('tariff');
            
            $('#driver-phone').val(phone);
            
            if (tariff) {
                $('#tariff-select').val(tariff);
                $('#tariff-select').trigger('change');
            }
        });

        $('#tariff-select').change(function() {
            try {
                const tariff = $(this).val();
                console.log('Изменение тарифа на:', tariff);
                
                if (tariff) {
                    $('#tariff-display').val(tariff);
                    calculatePrice();
                }
            } catch (error) {
                console.error('Ошибка при изменении тарифа:', error);
            }
        });
        
        // Обновление адресов при изменении полей
        $('#origin-address, #destination-address').on('change keyup', function() {
            const fieldId = $(this).attr('id');
            const address = $(this).val().trim();
            console.log('Изменен адрес в поле:', fieldId, '→', address);
            
            // Устанавливаем маркер на карте по введенному адресу
            if (address.length > 2) {
                const type = fieldId.includes('origin') ? 'origin' : 'destination';
                console.log('🎯 Устанавливаем маркер для:', type);
                
                // Небольшая задержка чтобы не спамить при наборе
                clearTimeout(window.addressTimeout);
                window.addressTimeout = setTimeout(function() {
                    setMarkerByAddress(address, type);
                }, 800); // 800мс задержка
            }
        });

        // Инициализация автодополнения для полей адресов
        function initAutocomplete() {
            $('#origin-address, #destination-address').each(function() {
                const $input = $(this);
                const $container = $input.parent();
                
                // Создаем контейнер для выпадающего списка
                if (!$container.find('.autocomplete-dropdown').length) {
                    $container.css('position', 'relative');
                    $container.append('<div class="autocomplete-dropdown"></div>');
                }
                
                const $dropdown = $container.find('.autocomplete-dropdown');
                
                $input.on('input', function() {
                    const value = $(this).val().toLowerCase().trim();
                    $dropdown.empty().hide();
                    
                    if (value.length >= 2) {
                        const matches = kyrgyzstanAddresses.filter(address => 
                            address.toLowerCase().includes(value)
                        ).slice(0, 15); // Показываем максимум 15 вариантов
                        
                        if (matches.length > 0) {
                            matches.forEach(address => {
                                const $item = $('<div class="autocomplete-item">' + address + '</div>');
                                $item.on('click', function() {
                                    $input.val(address);
                                    $dropdown.hide();
                                    console.log('✅ Выбран адрес из автодополнения:', address);
                                    
                                    // Сразу устанавливаем маркер при выборе из списка
                                    const type = $input.attr('id').includes('origin') ? 'origin' : 'destination';
                                    console.log('🎯 Устанавливаем маркер для выбранного адреса:', type);
                                    setMarkerByAddress(address, type);
                                });
                                $dropdown.append($item);
                            });
                            $dropdown.show();
                        }
                    }
                });
                
                // Скрываем выпадающий список при клике вне его
                $(document).on('click', function(e) {
                    if (!$container.is(e.target) && !$container.has(e.target).length) {
                        $dropdown.hide();
                    }
                });
            });
        }

        // Инициализируем автодополнение после загрузки
        setTimeout(initAutocomplete, 500);
        
        // Валидация адресов для Киргизии при ручном вводе (делаем менее строгой)
        $('#origin-address, #destination-address').on('blur', function() {
            const address = $(this).val().toLowerCase().trim();
            // Убираем строгую валидацию - проверяем только если введено что-то
            if (address && address.length > 2) {
                if (!isKyrgyzstanAddress(address)) {
                    // Не показываем alert, просто логируем предупреждение
                    console.warn('Введенный адрес может не относиться к Киргизии:', address);
                }
            }
        });
        
        // Проверка, относится ли адрес к Киргизии (улучшенная версия)
        function isKyrgyzstanAddress(address) {
            const kyrgyzstanKeywords = [
                'кыргызстан', 'киргизия', 'бишкек', 'ош', 'джалал-абад', 'джалалабад',
                'каракол', 'нарын', 'талас', 'баткен', 'чуй', 'иссык-куль', 'исыккуль',
                'кг', 'kg', 'bishkek', 'osh', 'jalal-abad', 'karakol', 
                'naryn', 'talas', 'batken', 'чолпон-ата', 'кербен', 'токмак',
                'кант', 'сокулук', 'беловодское', 'кемин', 'чолпон', 'ата',
                'кочкор', 'ат-башы', 'кызыл-кия', 'сулюкта', 'узген',
                'арсланбоб', 'майлуу-суу', 'жалал-абад', 'кайынды', 'базар-коргон',
                'ноокат', 'кара-суу', 'кара-кулжа', 'ленин', 'пик', 'ленина'
            ];
            
            // Если адрес содержит хотя бы одно ключевое слово - считаем валидным
            // Или если адрес просто числа/координаты - тоже валидным
            return kyrgyzstanKeywords.some(keyword => address.includes(keyword)) || 
                   /^[\d\.,\s\-]+$/.test(address); // Координаты или числа
        }
        
        // Обработка формы
        $('#order-form').submit(function(e) {
            e.preventDefault();
            
            const driverId = $('#driver-select').val();
            const tariff = $('#tariff-select').val();
            const paymentMethod = $('#payment-method').val();
            const origin = $('#origin-address').val();
            const destination = $('#destination-address').val();
            
            if (!driverId) {
                alert('Выберите водителя');
                return false;
            }
            if (!tariff) {
                alert('Выберите тариф');
                return false;
            }
            if (!paymentMethod) {
                alert('Выберите способ оплаты');
                return false;
            }
            if (!origin) {
                alert('Укажите адрес отправления');
                return false;
            }
            if (!destination) {
                alert('Укажите адрес назначения');
                return false;
            }
            
            // Проверяем, что адреса находятся в пределах Киргизии (делаем менее строгим)
            if (!isKyrgyzstanAddress(origin.toLowerCase())) {
                console.warn('Внимание: адрес отправления может не относиться к Киргизии');
                // Не блокируем отправку, только предупреждаем
            }
            if (!isKyrgyzstanAddress(destination.toLowerCase())) {
                console.warn('Внимание: адрес назначения может не относиться к Киргизии');
                // Не блокируем отправку, только предупреждаем
            }
            
            // Отправка формы
            $.ajax({
                type: 'POST',
                url: '/api/orders/',
                data: $(this).serialize(),
                success: function(response) {
                    alert('Заказ успешно создан!');
                    window.location.href = '/disp/';
                },
                error: function(error) {
                    alert('Ошибка при создании заказа: ' + (error.responseJSON ? error.responseJSON.detail : 'Проверьте соединение с сервером'));
                }
            });
        });
        
        // Отмена заказа
        $('#cancel-btn').click(function() {
            if (confirm('Вы уверены, что хотите отменить создание заказа?')) {
                window.location.href = '/disp/';
            }
        });
        
        // Нажатие клавиши F2 для создания нового заказа
        $(document).keydown(function(e) {
            if (e.keyCode === 113) { // F2 key
                e.preventDefault();
                window.location.reload();
            }
        });

        // Обработчик для кнопки "Очистить маркеры"
        $('#clear-markers-btn').click(function() {
            if (confirm('Очистить все маркеры и поля адресов?')) {
                // Очищаем маркер точки А
                if (originMarker) {
                    originMarker.destroy();
                    originMarker = null;
                    console.log('🗑️ Маркер точки А удален');
                }
                originCoords = null;
                $('#origin-address').val('');
                
                // Очищаем маркер точки Б
                if (destinationMarker) {
                    destinationMarker.destroy();
                    destinationMarker = null;
                    console.log('🗑️ Маркер точки Б удален');
                }
                destinationCoords = null;
                $('#destination-address').val('');
                
                // Очищаем маршрут
                if (routeLayer) {
                    routeLayer.destroy();
                    routeLayer = null;
                    console.log('🗑️ Маршрут удален');
                }
                
                // Сбрасываем расчеты
                distance = 0;
                duration = 0;
                $('#distance').val('Расстояние: 0 км');
                $('#price').val('Стоимость: 0 сом');
                $('#calculated-price').val(0);
                $('#boarding-fee').val('Посадка: 48 сом');
                
                // Сбрасываем счетчик кликов
                clickCounter = 0;
                
                // Центрируем карту на Ош
                if (map) {
                    map.setCenter([72.8019, 40.5138]);
                    map.setZoom(12);
                }
                
                console.log('✅ Все данные очищены, карта сброшена к начальному состоянию');
            }
        });
    } // Закрытие функции initApp
</script>
<style>
    /* Адаптивные стили */
    .main__order-wrapper {
        border-radius: 5px;
    }
    .main__order-header {
        flex-wrap: wrap;
    }
    .main__btn {
        padding: 12px 30px;
    }
    .main__order-subheader {
        gap: 20px;
        flex-wrap: wrap;
    }
    .main__order-subheader-item {
        width: 100%;
    } 
    .main__subheader-filing {
        width: 100%;
    }
    #tariff-select,
    #payment-method {
        width: 100%;
    }
    .main__order-subheader-item .main__btn-short {
        width: 100%;
    }
    .main__order-notes {
        width: 100%;
        display: flex;
        justify-content: space-between;
    } 
    .main__order-notes-text {
        width: 65%;
    }
    @media (max-width: 1200px) {
        .main__order-wrapper-blocks {
            flex-direction: column;
        }
        .main__order-settings, .main__order-map {
            width: 100%;
            margin-bottom: 20px;
        }
        .main__header-tags ul li {
            padding: 10px 15px;
        }
    }
    
    @media (max-width: 768px) {
        .main__header {
            flex-direction: column;
            align-items: flex-start;
        }
        .main__header-logo, .main__header-tags, .main__header-search {
            width: 100%;
            margin-bottom: 10px;
        }
        .main__subheader-add {
            flex-wrap: wrap;
        }
        .main__order-header, .main__order-subheader {
            flex-direction: column;
        }
        .main__order-header-item, .main__order-subheader-item {
            width: 100%;
            margin-bottom: 10px;
        }
        .main__order-details-item {
            flex-direction: column;
        }
        .main__order-details-item input {
            width: 100%;
            margin-bottom: 10px;
        }
        .main__order-map-item {
            height: 300px;
        }
    }
    
    /* Улучшения существующих стилей */
    .main__order-map-item {
        min-height: 400px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .main__btn, .main__btn-short, .main__btn-green {
        transition: all 0.3s ease;
    }
    
    .main__btn:hover, .main__btn-short:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .main__btn-green:hover {
        background-color: #35a63a;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .main__order-notes-text textarea {
        width: 100%;
        min-height: 80px;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #47484c;
        background-color: #2d2e33;
        color: #fff;
        resize: vertical;
    }
    
    /* Улучшения для карты и маршрута */
    .route-info {
        background-color: #2d2e33;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
    }
    
    .route-info-item {
        background-color: #47484c;
        padding: 10px 15px;
        border-radius: 5px;
        margin-bottom: 10px;
        width: 100%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .route-info-item input {
        width: 90%;
    }
    
    /* Стили для автодополнения адресов */
    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: #2d2e33;
        border: 1px solid #47484c;
        border-top: none;
        border-radius: 0 0 5px 5px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .autocomplete-item {
        padding: 10px 15px;
        cursor: pointer;
        color: #fff;
        border-bottom: 1px solid #47484c;
        transition: background-color 0.2s;
    }
    
    .autocomplete-item:hover {
        background-color: #47484c;
    }
    
    .autocomplete-item:last-child {
        border-bottom: none;
    }
    
    /* Улучшение стилей для полей ввода адресов */
    .main__order-details-item {
        position: relative;
    }
    
    @media (max-width: 576px) {
        .route-info-item {
            width: 100%;
        }
    }
</style>
{% endblock %}